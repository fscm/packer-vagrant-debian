{
  "variables": {
    "os_name": "debian",
    "os_codename": "jessie",
    "os_verion": "8.6.0",
    "os_arch": "amd64",
    "os_arch_short": "64",
    "os_type": "Debian_64",
    "system_disk_size": "8192",
    "system_keymap": "pt",
    "system_locale": "en_US",
    "system_user": "pollywog",
    "system_pwd": "jessie",
    "system_domain": "marsh"
  },
  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "{{user `os_type`}}",
      "vm_name": "{{user `os_codename`}}{{user `os_arch_short`}}",
      "http_directory": "http",
      "headless": true,
      "disk_size": "{{user `system_disk_size`}}",
      "iso_url": "http://cdimage.debian.org/debian-cd/{{user `os_verion`}}/{{user `os_arch`}}/iso-cd/debian-{{user `os_verion`}}-{{user `os_arch`}}-netinst.iso",
      "iso_checksum": "6c3b53d2a33e34644153683f4492a7773340812c540eb3c5fdeee61e0c8dbafb2f9d634db0d2518b44fbf16770ec15f80561b49c280e27984e887ac71bfb3c3a",
      "iso_checksum_type": "sha512",
      "iso_target_path": "../../builds/cache/debian-{{user `os_verion`}}-{{user `os_arch`}}-netinst.iso",
      "ssh_username": "{{user `system_user`}}",
      "ssh_password": "{{user `system_pwd`}}",
      "ssh_port": 22,
      "ssh_wait_timeout": "3600s",
      "shutdown_command": "echo '{{user `system_pwd`}}' | sudo -S /sbin/shutdown -hP now",
      "guest_additions_mode": "disable",
      "hard_drive_interface": "sata",
      "output_directory": "../../builds/sandbox/{{ .Provider }}",
      "boot_wait": "10s",
      "boot_command": [
        "<esc><wait>",
        "auto preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
        "netcfg/get_hostname={{user `os_codename`}} ",
        "netcfg/get_domain={{user `system_domain`}} ",
        "passwd/username={{user `system_user`}} ",
        "passwd/user-password={{user `system_pwd`}} ",
        "passwd/user-password-again={{user `system_pwd`}}<enter>"
      ],
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "384"],
        ["modifyvm", "{{.Name}}", "--vram", "12"],
        ["modifyvm", "{{.Name}}", "--pae", "off"],
        ["modifyvm", "{{.Name}}", "--cpus", "1"],
        ["modifyvm", "{{.Name}}", "--hwvirtex", "on"],
        ["modifyvm", "{{.Name}}", "--paravirtprovider", "legacy"],
        ["modifyvm", "{{.Name}}", "--nestedpaging", "on"],
        ["modifyvm", "{{.Name}}", "--accelerate3d", "off"],
        ["modifyvm", "{{.Name}}", "--accelerate2dvideo", "off"],
        ["modifyvm", "{{.Name}}", "--chipset", "piix3"],
        ["modifyvm", "{{.Name}}", "--boot1", "dvd"],
        ["modifyvm", "{{.Name}}", "--boot2", "disk"],
        ["modifyvm", "{{.Name}}", "--boot3", "none"],
        ["modifyvm", "{{.Name}}", "--boot4", "none"],
        ["modifyvm", "{{.Name}}", "--mouse", "ps2"],
        ["modifyvm", "{{.Name}}", "--keyboard", "ps2"],
        ["modifyvm", "{{.Name}}", "--audio", "none"],
        ["modifyvm", "{{.Name}}", "--usb", "off"],
        ["modifyvm", "{{.Name}}", "--vrde", "off"]
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "sudo apt-get update",
        "sudo apt-get -y -q install linux-headers-amd64 virtualbox-guest-dkms virtualbox-guest-utils vim wget dbus",
        "sudo apt-get -y -q purge dictionaries* emacs* iamerican* ibritish* ienglish* ispell nfacct tcpd vim-tiny",
        "sudo apt-get -y -q purge libx11-data xauth libxmuu1 libxcb1 libx11-6 libxext6",
        "sudo apt-get -y -q --purge autoremove",
        "sudo apt-get autoclean",
        "sudo apt-get clean",
        "sudo update-alternatives --set editor /usr/bin/vim.basic",
        "echo 'dash dash/sh boolean false' | sudo debconf-set-selections",
        "sudo DEBIAN_FRONTEND=noninteractive dpkg-reconfigure dash",
        "sudo sed -i -e '/^#NAutoVTs/aNAutoVTs=2' /etc/systemd/logind.conf",
        "sudo update-locale LC_CTYPE=en_US.UTF-8",
        "sudo swaplabel -L SWAP /dev/sda1",
        "sudo sed -i -e '/cdrom/d' /etc/fstab",
        "sudo sed -r -i -e 's/(UUID=)[^ ]* (.*)/LABEL=SWAP      \\2/' /etc/fstab",
        "sudo sed -r -i -e 's/(GRUB_TIMEOUT)=(.*)/\\1=1/' /etc/default/grub",
        "sudo sed -r -i -e 's/.*(GRUB_CMDLINE_LINUX)=\"(.*)\"/\\1=\"\\2 cgroup_enable=memory\"/' /etc/default/grub",
        "sudo update-grub2",
        "echo 'blacklist intel_rapl' | sudo tee -a /etc/modprobe.d/rapl-blacklist.conf > /dev/null",
        "echo 'blacklist i2c_piix4' | sudo tee -a /etc/modprobe.d/piix4-blacklist.conf > /dev/null",
        "sudo update-initramfs -u -k all",
        "echo 'UseDNS no' | sudo tee -a /etc/ssh/sshd_config > /dev/null",
        "sudo mkdir /shared",
        "sudo chown {{user `system_user`}}:{{user `system_user`}} /shared",
        "sudo mkdir -p /home/{{user `system_user`}}/.ssh",
        "sudo wget -q --no-check-certificate https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub -O /home/{{user `system_user`}}/.ssh/authorized_keys",
        "sudo chmod 0700 /home/{{user `system_user`}}/.ssh",
        "sudo chmod 0600 /home/{{user `system_user`}}/.ssh/authorized_keys",
        "sudo chown -R {{user `system_user`}}:{{user `system_user`}} /home/{{user `system_user`}}/.ssh",
        "sudo rm -f /root/.bash_history",
        "sudo rm -f /home/{{user `system_user`}}/.bash_history",
        "sudo rm -f /home/{{user `system_user`}}/.vbox_version",
        "sudo rm -f /var/log/wtmp",
        "sudo rm -f /var/log/btmp",
        "sudo rm -rf /var/log/installer",
        "sudo find /usr/share/locale/* -maxdepth 0 -type d \\! -name 'pt*' \\! -name 'en*' -exec rm -rf {} \\;",
        "sudo find /usr/share/doc/* -maxdepth 0 \\! -name 'virtualbox*' -exec rm -rf {} \\;",
        "sudo find /var/cache -type f -delete",
        "sudo find /var/log -type f | while read f; do echo -n '' | sudo tee $f > /dev/null; done;",
        "sudo find /var/lib/apt/lists \\! -name lock -type f -delete",
        "sudo swapoff /dev/sda1",
        "sudo dd if=/dev/zero of=/dev/sda1 || echo 'dd exit code suppressed'",
        "sudo mkswap -L SWAP /dev/sda1",
        "sudo swapon /dev/sda1",
        "sudo dd if=/dev/zero of=/EMPTY bs=1M || echo 'dd exit code suppressed'",
        "sudo rm -f /EMPTY",
        "sudo sync"
      ]
    },
    {
      "type": "shell-local",
      "command": "sed -i '' -e 's/\\(.*config.ssh.username.*\\)=.*/\\1= \"{{user `system_user`}}\"/' Vagrantfile.tpl"
    }
  ],
  "post-processors": [
    [
      {
        "type": "vagrant",
        "compression_level": 9,
        "keep_input_artifact": false,
        "vagrantfile_template": "Vagrantfile.tpl",
        "output": "../../builds/providers/{{.Provider}}/{{user `os_codename`}}{{user `os_arch_short`}}.box"
      }
    ]
  ]
}
